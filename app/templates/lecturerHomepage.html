{% extends "base.html" %}

{% block title %}Lecturer Dashboard - CourseXcel{% endblock %}

{% block content %}
<div class="main-container">
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-links">
                <a href="{{ url_for('lecturerHomepage') }}" class="nav-link {% if request.endpoint == 'lecturerHomepage' %}active{% endif %}">Home</a>
                <a href="{{ url_for('lecturerFormPage') }}" class="nav-link {% if request.endpoint == 'lecturerFormPage' %}active{% endif %}">Form</a>
                <a href="{{ url_for('lecturerClaimsPage') }}" class="nav-link {% if request.endpoint == 'lecturerClaimsPage' %}active{% endif %}">Claims</a>
                <a href="{{ url_for('lecturerProfilePage') }}" class="nav-link {% if request.endpoint == 'lecturerProfilePage' %}active{% endif %}">Profile</a>
            </div>
        </div>
    </nav>  

    <div class="content-wrapper">
        <!-- Action Cards Row -->
        <div class="action-cards">
            <!-- Generate Claim -->
            <div class="card action-card report-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Submit Claim</h3>
                <p class="form-text">Fill out the form to submit claims.</p>
                <a href="{{ url_for('lecturerFormPage') }}" class="form-btn">Go</a>
            </div>

            <!-- View Approvals -->
            <div class="card action-card head-card">
                <h3><i class="fas fa-user-tie"></i> View Approvals</h3>
                <p class="form-text">View claim approval statuses.</p>
                <a href="{{ url_for('lecturerClaimsPage') }}" class="form-btn">Go</a>
            </div>
        </div>

        <!-- Dashboard Charts -->
        <div class="dashboard-grid">
            <!-- Subjects Assigned -->
            <div class="card">
                <h3>Subjects Assigned</h3>
                <div style="display:flex; justify-content:center; align-items:center; height:90%;">
                    <div style="position:relative; width:220px; height:220px;">
                        <canvas id="subjectsAssignedChart"></canvas>
                        <div id="subjectCountText" 
                            style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
                                    font-size:26px; font-weight:bold; color:#e84393;">
                            {{ subject_count }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hours taught vs. Assigned -->
            <div class="card">
                <h3>Hours Taught vs Assigned</h3>
                <canvas id="subjectHoursChart"></canvas>
            </div>

            <!-- Claim Trend -->
            <div class="card span-2">
                <div class="card-header">
                    <h3>Claim Trend</h3>
                    <select id="claimTrendYear"></select>
                </div>
                <canvas id="claimTrendChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/po.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ========== Subjects Assigned ==========
        const subjectCount = JSON.parse('{{ subject_count | tojson | safe }}');
        const maxSubjects = 4;

        new Chart(document.getElementById('subjectsAssignedChart'), {
            type: 'doughnut',
            data: {
                labels: ["Assigned", "Remaining"],
                datasets: [{
                    data: [subjectCount, Math.max(maxSubjects - subjectCount, 0)],
                    backgroundColor: ["#e84393", "#f1f1f1"],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: "70%",   // thickness of ring
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });

        // ========== Hours taught vs assigned ==========
        const subjectHours = JSON.parse('{{ subject_hours | tojson | safe }}');

        const labels = subjectHours.map(item => item.subject);
        const assigned = subjectHours.map(item => item.assigned);
        const taught = subjectHours.map(item => item.taught);

        if (window.hoursChart) {
            window.hoursChart.destroy();
        }

        const ctx = document.getElementById('subjectHoursChart');
        window.hoursChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Assigned Hours",
                        data: assigned,
                        backgroundColor: "rgba(230, 126, 34, 0.6)",
                        pointStyle: 'rect'
                    },
                    {
                        label: "Taught Hours",
                        data: taught,
                        type: 'line',
                        borderColor: "rgba(232, 67, 147, 1)",   // solid line
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3,
                        pointStyle: 'circle'
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: "Hours" }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { usePointStyle: true }
                    }
                }
            }
        });
      
        // ========== Claim Trend ==========
        const subjectClaims = JSON.parse('{{ subject_claims | tojson | safe }}'); 
        const monthLabels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

        function populateYears() {
            const yearSelect = document.getElementById("claimTrendYear");
            yearSelect.innerHTML = ""; // reset

            const years = Object.keys(subjectClaims || {}).sort();
            years.forEach(y => {
                const opt = document.createElement("option");
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });

            if (years.length > 0) {
                yearSelect.value = years[0];   // auto-select first year
                renderClaimChart(years[0]);    // draw chart immediately
            } else {
                renderClaimChart(null);        // fallback empty chart
            }
        }

        function renderClaimChart(year) {
            const ctx = document.getElementById('claimTrendChart').getContext('2d');
            const data = subjectClaims[year] || [];

            // Align data to months Janâ€“Dec
            const values = monthLabels.map((_, i) => {
                const monthData = data.find(item => item.month === i+1);
                return monthData ? monthData.total_claims / 1000 : 0; // convert to RM'000
            });

            if (window.claimChart) {
                window.claimChart.destroy();
            }

            window.claimChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: "Claims",
                        data: values,
                        borderColor: "#3498db",
                        backgroundColor: "rgba(52,152,219,0.3)", 
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 0.5 },
                            title: { display: true, text: "Total Claims" }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const month = context.label; // "Jan", "Feb", etc.
                                    const value = context.raw;   // numeric value
                                    return `Claims: RM ${value}k`;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.getElementById("claimTrendYear").addEventListener("change", function() {
            renderClaimChart(this.value);
        });

        populateYears();
    });
</script>
{% endblock %}
