{% extends "base.html" %}

{% block title %}Admin Dashboard - CourseXcel{% endblock %}

{% block content %}
<div class="main-container">
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-links">
                <a href="{{ url_for('adminHomepage') }}" class="nav-link {% if request.endpoint == 'adminHomepage' %}active{% endif %}">Home</a>
                <a href="{{ url_for('adminSubjectsPage') }}" class="nav-link {% if request.endpoint == 'adminSubjectsPage' %}active{% endif %}">Subjects</a>
                <a href="{{ url_for('adminUsersPage') }}" class="nav-link {% if request.endpoint == 'adminUsersPage' %}active{% endif %}">Users</a>
                <a href="{{ url_for('adminApprovalsPage') }}" class="nav-link {% if request.endpoint == 'adminApprovalsPage' %}active{% endif %}">Approvals</a>
                <a href="{{ url_for('adminReportPage') }}" class="nav-link {% if request.endpoint == 'adminReportPage' %}active{% endif %}">Report</a>
                <a href="{{ url_for('adminProfilePage') }}" class="nav-link {% if request.endpoint == 'adminProfilePage' %}active{% endif %}">Profile</a>
            </div>
        </div>
    </nav>    

    <div class="content-wrapper">
        <!-- Action Cards Row -->
        <div class="action-cards">
            <!-- Upload Course Structure -->
            <div class="card action-card course-card">
                <h3><i class="fas fa-upload"></i> Upload Course Structure</h3>
                <p class="form-text">Upload and manage subjects and hours.</p>
                <a href="{{ url_for('adminSubjectsPage') }}" class="form-btn">Go</a>
            </div>

            <!-- Upload Lecturer List -->
            <div class="card action-card lecturer-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Upload Lecturer List</h3>
                <p class="form-text">Upload and manage part-time lecturers.</p>
                <a href="{{ url_for('adminUsersPage') }}" class="form-btn">Go</a>
            </div>

            <!-- Upload Head List -->
            <div class="card action-card head-card">
                <h3><i class="fas fa-user-tie"></i> Upload Head List</h3>
                <p class="form-text">Upload and manage head of programmes.</p>
                <a href="{{ url_for('adminUsersPage') }}" class="form-btn">Go</a>
            </div>
        </div>

        <!-- Row with Report + Export -->
        <div class="action-cards">
            <!-- Generate Report -->
            <div class="card action-card report-card">
                <h3><i class="fas fa-chart-line"></i> Generate Report</h3>
                <p class="form-text">
                    Generate requisition and claim reports with insights for management.<br><br>
                    For <strong>Requisition Reports</strong>: includes a summary of how many subjects each lecturer is assigned, 
                    the total teaching hours and costs, and a breakdown by department.<br><br>
                    For <strong>Claim Reports</strong>: provides a summary of lecturer claims including the number of subjects claimed, 
                    the total claim costs, and a departmental breakdown for easy comparison.
                </p>

                <a href="{{ url_for('adminReportPage') }}" class="form-btn">Go</a>
            </div>

            <!-- Export & Clear Section (Highlight Card) -->
            <div class="card export-card">
                <h3><i class="fas fa-file-export"></i> Export & Clear Completed Approvals</h3>
                <p class="form-text">
                    Download all completed requisition and claim approval files with their attachments.<br>
                    Once downloaded, the files will be cleared from the database and storage.
                </p>

                <button type="button" id="downloadBtn" class="form-btn">Export & Clear</button>
                <details open style="margin-top: 5px;">
                    <summary><strong>Download conditions</strong></summary>
                    <ul>
                        <li>Both requisition and claim approvals must be marked <em>Completed</em>.</li>
                        <li>The teaching period end date must be at least 4 months before today.</li>
                        <li>Total cost claimed must equal the total allocated cost (no remaining claims).</li>
                    </ul>
                </details>
            </div>
        </div>

        <!-- Dashboard Charts -->
        <div class="dashboard-grid">            
            <!-- Subjects per Lecturer -->
            <div class="card">
                <div class="card-header">
                    <h3>Subjects Assigned per Part-Time Lecturer</h3>
                    <select id="subjectsPerLecturerDept">
                        {% for dept in departments %}
                            <option value="{{ dept.department_id }}">{{ dept.department_code }}</option>
                        {% endfor %}
                    </select>
                </div>
                <canvas id="subjectsPerLecturerChart"></canvas>
            </div>

            <!-- Lecturer Claim Trend -->
            <div class="card">
                <div class="card-header">
                    <h3>Part-Time Lecturer Claim Trend</h3>
                    <select id="claimTrendDept">
                        {% for dept in departments %}
                            <option value="{{ dept.department_id }}">{{ dept.department_code }}</option>
                        {% endfor %}
                    </select>
                    <select id="claimTrendYear"></select>
                </div>
                <canvas id="claimTrendChart"></canvas>
            </div>

            <!-- Peak Claim Periods -->
            <div class="card">
                <div class="card-header">
                    <h3>Peak Claim Months</h3>
                    <select id="peakClaimYear">
                        {% for year in year_claims.keys() %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <canvas id="peakClaimChart"></canvas>
            </div>

            <!-- Pie Chart for Records -->
            <div class="card">
                <h3>Records Distribution</h3>
                <canvas id="recordsPieChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        downloadBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!confirm('Are you sure you want to proceed?')) return;

            try {
                document.getElementById("loadingOverlay").style.display = "flex";
                const response = await fetch('/api/download_files_zip', { method: 'POST' });
                document.getElementById("loadingOverlay").style.display = "none";

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    alert(data.error || 'Failed to prepare download.');
                    return;
                }

                // Download the ZIP
                const disposition = response.headers.get('Content-Disposition') || '';
                const match = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"/i.exec(disposition);
                const filename = decodeURIComponent(match?.[1] || match?.[2] || `Approvals and Attachments_${new Date().toISOString().slice(0,10)}.zip`);

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                a.download = filename;
                document.body.appendChild(a); 
                a.click();
                URL.revokeObjectURL(url); 
                a.remove();

                // Cleanup on the server
                const cleanup = await fetch('/api/cleanup_downloaded_files', { method: 'POST' });
                const result = await cleanup.json().catch(() => ({}));
                if (!cleanup.ok) {
                    alert(result.error || 'Cleanup failed on the server.');
                } else {
                    alert('Download prepared and records cleaned up successfully.');
                }
            } catch (err) {
                document.getElementById("loadingOverlay").style.display = "none";
                alert('Error preparing download: ' + err.message);
            }
        });

        const deptColors = {
            "1": "#e84393", // Pink
            "2": "#e74c3c", // Red
            "3": "#e67e22", // Orange
            "4": "#f1c40f", // Yellow
            "5": "#2ecc71", // Green
            "6": "#3498db", // Blue
            "7": "#8e44ad", // Indigo
            "8": "#7f8c8d"  // Gray
        };

        // Generate lighter/darker shades
        function shadeColor(color, percent, alpha = 0.7) {
            let R = parseInt(color.substring(1,3),16);
            let G = parseInt(color.substring(3,5),16);
            let B = parseInt(color.substring(5,7),16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;

            return `rgba(${R}, ${G}, ${B}, ${alpha})`;
        }

        // ========== Subjects per Lecturer ==========
        const deptSubjects = JSON.parse('{{ dept_subjects | tojson | safe }}');

        function renderSubjectsPerLecturerChart(deptId) {
            const ctx = document.getElementById('subjectsPerLecturerChart').getContext('2d');
            const data = deptSubjects[deptId] || [];

            const labels = data.map(item => item.lecturer);
            const values = data.map(item => item.count);

            // Pick department base color (default blue if not defined)
            const baseColor = deptColors[deptId] || "#3498db";

            // Generate gradient of shades
            const colors = values.map((_, i) => shadeColor(baseColor, (i - values.length/2) * 20));

            if (window.subjectsChart) {
                window.subjectsChart.destroy();
            }

            window.subjectsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Subjects",
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1, 
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : null; 
                                }
                            },
                            title: {
                                display: true,
                                text: 'Number of Subjects',
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // On page load
        const defaultSubjectsPerLecturerDept = document.getElementById('subjectsPerLecturerDept').value;
        renderSubjectsPerLecturerChart(defaultSubjectsPerLecturerDept);

        // Dropdown change
        document.getElementById('subjectsPerLecturerDept').addEventListener('change', function() {
            renderSubjectsPerLecturerChart(this.value);
        });

        // ========== Claim Trend ==========
        const deptClaims = JSON.parse('{{ dept_claims | tojson | safe }}');
        const monthLabels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

        function populateYears(deptId) {
            const yearSelect = document.getElementById("claimTrendYear");
            yearSelect.innerHTML = ""; // reset

            const years = Object.keys(deptClaims[deptId] || {}).sort();
            years.forEach(y => {
                const opt = document.createElement("option");
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });
        }

        function renderClaimTrendChart(deptId, year) {
            const ctx = document.getElementById('claimTrendChart').getContext('2d');
            const data = (deptClaims[deptId] && deptClaims[deptId][year]) || [];

            // Convert to array aligned by months
            const values = monthLabels.map((_, i) => {
                const monthData = data.find(item => item.month === i+1);
                return monthData ? monthData.total_claims / 1000 : 0; // RM'000
            });

            const baseColor = deptColors[deptId] || "#3498db";
            const borderColor = baseColor;
            const backgroundColor = shadeColor(baseColor, 0, 0.3); 

            if (window.claimChart) {
                window.claimChart.destroy();
            }

            window.claimChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: "Claims",
                        data: values,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 0.5 },
                            title: { display: true, text: "Total Claims" }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const month = context.label; // "Jan", "Feb", etc.
                                    const value = context.raw;   // numeric value
                                    return `Claims: RM ${value}k`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Init: default dept and its first year
        const defaultClaimTrendDept = document.getElementById("claimTrendDept").value;
        populateYears(defaultClaimTrendDept);
        const defaultClaimTrendYear = document.getElementById("claimTrendYear").value;
        renderClaimTrendChart(defaultClaimTrendDept, defaultClaimTrendYear);

        // Change events
        document.getElementById("claimTrendDept").addEventListener("change", function() {
            populateYears(this.value);
            const firstYear = document.getElementById("claimTrendYear").value;
            renderClaimTrendChart(this.value, firstYear);
        });

        document.getElementById("claimTrendYear").addEventListener("change", function() {
            const deptId = document.getElementById("claimTrendDept").value;
            renderClaimTrendChart(deptId, this.value);
        });

        // ========== Peak Claim Periods ==========
        const yearClaims = JSON.parse('{{ year_claims | tojson | safe }}');
        const deptMap = JSON.parse('{{ dept_map | tojson | safe }}');

        function renderPeakClaimChart(year) {
            const ctx = document.getElementById('peakClaimChart').getContext('2d');
            const data = yearClaims[year] || [];

            // Collect unique months & sort them
            const months = [...new Set(data.map(item => item.month))].sort((a, b) => a - b);

            // Convert month numbers to labels
            const peakMonthLabels = months.map(m => {
                const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                return monthNames[m - 1];
            });

            // Collect unique departments
            const deptIds = [...new Set(data.map(item => item.department_id))];

            // Build datasets per department
            const datasets = deptIds.map(did => {
                return {
                    label: deptMap[did] || `Dept ${did}`,
                    data: months.map(m => {
                        const entry = data.find(item => item.department_id === did && item.month === m);
                        return entry ? entry.total_claims / 1000 : 0; // RMâ€™000
                    }),
                    backgroundColor: shadeColor(deptColors[did], 0, 0.3) || "#3498db"
                };
            });

            if (window.peakChart) {
                window.peakChart.destroy();
            }

            window.peakChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: peakMonthLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const month = context.label;
                                    const value = context.raw;
                                    return `Claims: RM ${value}k`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true, 
                            beginAtZero: true,
                            ticks: { stepSize: 0.5 },
                            title: { display: true, text: "Total Claims" }
                        }
                    }
                }
            });
        }

        // Default = first year in dropdown
        const defaultPeakClaimYear = document.getElementById('peakClaimYear').value;
        renderPeakClaimChart(defaultPeakClaimYear);

        // On year change
        document.getElementById("peakClaimYear").addEventListener("change", function() {
            renderPeakClaimChart(this.value);
        });

        // ========== Records Pie Chart ==========
        const recordsData = JSON.parse('{{ records_counts | tojson | safe }}');

        new Chart(document.getElementById('recordsPieChart'), {
            type: 'pie',
            data: {
                labels: ["Departments", "Subjects", "Program Officers", "Part-Time Lecturers", "Head of Programmes"],
                datasets: [{
                    data: recordsData,
                    backgroundColor: [
                        "#e74c3c",  /* red */
                        "#e67e22",  /* orange */
                        "#2ecc71",   /* green */
                        "#3498db",  /* blue */
                        "#9b59b6"  /* purple */
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.8, // lower = taller, higher = wider
                plugins: { legend: { position: 'top' } }
            }
        });
    });
</script>
{% endblock %}
