{% extends "base.html" %}

{% block title %}Admin Dashboard - CourseXcel{% endblock %}

{% block content %}
<div class="main-container">
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-links">
                <a href="{{ url_for('adminHomepage') }}" class="nav-link {% if request.endpoint == 'adminHomepage' %}active{% endif %}">Home</a>
                <a href="{{ url_for('adminSubjectsPage') }}" class="nav-link {% if request.endpoint == 'adminSubjectsPage' %}active{% endif %}">Subjects</a>
                <a href="{{ url_for('adminUsersPage') }}" class="nav-link {% if request.endpoint == 'adminUsersPage' %}active{% endif %}">Users</a>
                <a href="{{ url_for('adminApprovalsPage') }}" class="nav-link {% if request.endpoint == 'adminApprovalsPage' %}active{% endif %}">Approvals</a>
                <a href="{{ url_for('adminReportPage') }}" class="nav-link {% if request.endpoint == 'adminReportPage' %}active{% endif %}">Report</a>
                <a href="{{ url_for('adminProfilePage') }}" class="nav-link {% if request.endpoint == 'adminProfilePage' %}active{% endif %}">Profile</a>
            </div>
        </div>
    </nav>    

    <div class="content-wrapper">
        <!-- Action Cards Row -->
        <div class="action-cards">
            <!-- Upload Course Structure -->
            <div class="card action-card course-card">
                <h3><i class="fas fa-upload"></i> Upload Course Structure</h3>
                <p class="form-text">Upload and manage subjects and hours.</p>
                <a href="{{ url_for('adminSubjectsPage') }}" class="form-btn">Go</a>
            </div>

            <!-- Upload Lecturer List -->
            <div class="card action-card lecturer-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Upload Lecturer List</h3>
                <p class="form-text">Upload and manage part-time lecturers.</p>
                <a href="{{ url_for('adminUsersPage') }}" class="form-btn">Go</a>
            </div>

            <!-- Upload Head List -->
            <div class="card action-card head-card">
                <h3><i class="fas fa-user-tie"></i> Upload Head List</h3>
                <p class="form-text">Upload and manage head of programmes.</p>
                <a href="{{ url_for('adminUsersPage') }}" class="form-btn">Go</a>
            </div>
        </div>

        <!-- Row with Report + Export -->
        <div class="action-cards">
            <!-- Generate Report -->
            <div class="card action-card report-card">
                <h3><i class="fas fa-chart-line"></i> Generate Report</h3>
                <p class="form-text">
                    Generate requisition and claim reports with insights for management.<br><br>
                    For <strong>Requisition Reports</strong>: includes a summary of how many subjects each lecturer is assigned, 
                    the total teaching hours and costs, and a breakdown by department.<br><br>
                    For <strong>Claim Reports</strong>: provides a summary of lecturer claims including the number of subjects claimed, 
                    the total claim costs, and a departmental breakdown for easy comparison.
                </p>

                <a href="{{ url_for('adminReportPage') }}" class="form-btn">Go</a>
            </div>

            <!-- Export & Clear Section (Highlight Card) -->
            <div class="card export-card">
                <h3><i class="fas fa-file-export"></i> Export & Clear Completed Approvals</h3>
                <p class="form-text">
                    Download all completed requisition and claim approval files with their attachments.<br>
                    Once downloaded, the files will be cleared from the database and storage.
                </p>

                <button type="button" id="downloadBtn" class="form-btn">Export & Clear</button>
                <details open style="margin-top: 5px;">
                    <summary><strong>Download conditions</strong></summary>
                    <ul>
                        <li>Both requisition and claim approvals must be marked <em>Completed</em>.</li>
                        <li>The teaching period end date must be at least 4 months before today.</li>
                        <li>Total cost claimed must equal the total allocated cost (no remaining claims).</li>
                    </ul>
                </details>
            </div>
        </div>

        <!-- Dashboard Charts -->
        <div class="dashboard-grid">
            <!-- Regression Chart for Lecturer Needs -->
            <div class="card span-2">
                <div class="card-header">
                    <h3>Forecast Part-Time Lecturers Needed</h3>
                    <select id="lecturerForecastDept">
                        <option value="all">All Departments</option>
                        <option value="cs">Computer Science</option>
                        <option value="eng">Engineering</option>
                    </select>
                </div>
                <canvas id="lecturerForecastChart"></canvas>
            </div>

            <!-- Regression Chart for Budget Allocation -->
            <div class="card span-2">
                <div class="card-header">
                    <h3>Forecast Future Budget Allocation</h3>          
                    <select id="budgetForecastDept">
                        <option value="all">All Departments</option>
                        <option value="cs">Computer Science</option>
                        <option value="eng">Engineering</option>
                    </select>
                </div>
                <canvas id="budgetForecastChart"></canvas>
            </div>

            <!-- Subjects per Lecturer -->
            <div class="card">
                <div class="card-header">
                <h3>Subjects Assigned per Lecturer</h3>
                    <select id="subjectsDept">
                        {% for dept in departments %}
                            <option value="{{ dept.department_id }}">{{ dept.department_code }}</option>
                        {% endfor %}
                    </select>
                </div>
                <canvas id="subjectsPerLecturerChart"></canvas>
            </div>

            <!-- Lecturer Claim Trend -->
            <div class="card">
                <div class="card-header">
                <h3>Part-Time Lecturer Claim Trend</h3>
                    <select id="claimDept">
                        <option value="all">All Departments</option>
                        <option value="cs">Computer Science</option>
                        <option value="eng">Engineering</option>
                    </select>
                </div>
                <canvas id="claimTrendChart"></canvas>
            </div>

            <!-- Peak Claim Periods -->
            <div class="card">
                <div class="card-header">
                    <h3>Peak Claim Periods</h3>
                    <select id="peakDept">
                        <option value="all">All Departments</option>
                        <option value="cs">Computer Science</option>
                        <option value="biz">Business</option>
                    </select>
                </div>
                <canvas id="peakClaimChart"></canvas>
            </div>

            <!-- Pie Chart for Records -->
            <div class="card">
                <h3>Records Distribution by Table</h3>
                <canvas id="recordsPieChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        downloadBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!confirm('Are you sure you want to proceed?')) return;

            try {
                document.getElementById("loadingOverlay").style.display = "flex";
                const response = await fetch('/api/download_files_zip', { method: 'POST' });
                document.getElementById("loadingOverlay").style.display = "none";

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    alert(data.error || 'Failed to prepare download.');
                    return;
                }

                // Download the ZIP
                const disposition = response.headers.get('Content-Disposition') || '';
                const match = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"/i.exec(disposition);
                const filename = decodeURIComponent(match?.[1] || match?.[2] || `Approvals and Attachments_${new Date().toISOString().slice(0,10)}.zip`);

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                a.download = filename;
                document.body.appendChild(a); 
                a.click();
                URL.revokeObjectURL(url); 
                a.remove();

                // Cleanup on the server
                const cleanup = await fetch('/api/cleanup_downloaded_files', { method: 'POST' });
                const result = await cleanup.json().catch(() => ({}));
                if (!cleanup.ok) {
                    alert(result.error || 'Cleanup failed on the server.');
                } else {
                    alert('Download prepared and records cleaned up successfully.');
                }
            } catch (err) {
                document.getElementById("loadingOverlay").style.display = "none";
                alert('Error preparing download: ' + err.message);
            }
        });

        // ----- Lecturer Forecast -----
        new Chart(document.getElementById('lecturerForecastChart'), {
            type: 'line',
            data: {
            labels: ["2024","2025","2026","2027","2028"],
            datasets: [{
                label: "Estimated Lecturers",
                data: [20, 25, 30, 35, 42],
                borderColor: "blue",
                fill: false
            }]
            }
        });

        // ----- Budget Forecast -----
        new Chart(document.getElementById('budgetForecastChart'), {
            type: 'line',
            data: {
            labels: ["2024","2025","2026","2027","2028"],
            datasets: [{
                label: "Budget (in RM'000)",
                data: [500, 550, 620, 700, 780],
                borderColor: "green",
                fill: false
            }]
            }
        });

        // ----- Subjects per Lecturer -----
        const deptData = JSON.parse('{{ dept_data | tojson | safe }}');
        const defaultDept = Object.keys(deptData)[0];

        function renderSubjectsChart(deptId) {
            const ctx = document.getElementById('subjectsPerLecturerChart').getContext('2d');
            const data = deptData[deptId] || [];

            const labels = data.map(item => item.lecturer);
            const values = data.map(item => item.count);

            if (window.subjectsChart) {
                window.subjectsChart.destroy();
            }

            window.subjectsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Subjects",
                        data: values,
                        backgroundColor: "#3498db"
                    }]
                }
            });
        }

        // On page load
        renderSubjectsChart(defaultDept);

        // Dropdown change
        document.getElementById('subjectsDept').addEventListener('change', function() {
            renderSubjectsChart(this.value);
        });

        // ---- Claim Trend -----
        new Chart(document.getElementById('claimTrendChart'), {
            type: 'line',
            data: {
            labels: ["Jan","Feb","Mar","Apr","May","Jun"],
            datasets: [{
                label: "Claims (RM'000)",
                data: [20, 35, 28, 40, 55, 38],
                borderColor: "orange",
                fill: false
            }]
            }
        });

        // ----- Peak Claim Periods (Month/Year) -----
        new Chart(document.getElementById('peakClaimChart'), {
            type: 'bar',
            data: {
            labels: ["Jan-24","Feb-24","Mar-24","Apr-24","May-24","Jun-24"],
            datasets: [{
                label: "Claims",
                data: [12, 18, 9, 25, 30, 15],
                backgroundColor: "#2ecc71"
            }]
            }
        });

        // ----- Records Pie Chart -----
        const chartData = JSON.parse('{{ [departments_count, rates_count, subjects_count, program_officers_count, lecturers_count, heads_count] | tojson | safe }}');

        new Chart(document.getElementById('recordsPieChart'), {
        type: 'pie',
        data: {
            labels: ["Departments", "Rates", "Subjects", "Program Officers", "Part-Time Lecturers", "Head of Programmes"
            ],
            datasets: [{
                data: chartData,
                backgroundColor: [
                    "#e74c3c",  /* red */
                    "#e67e22",  /* orange */
                    "#ffff00",  /* bright yellow */
                    "#2ecc71",   /* green */
                    "#3498db",  /* blue */
                    "#9b59b6"  /* purple */
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
        });
    });
</script>
{% endblock %}
