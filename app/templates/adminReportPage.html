{% extends "base.html" %}
{% block title %}Admin Dashboard - CourseXcel{% endblock %}
{% block extra_head %}
<meta name="current-tab" content="{{ session.get('adminReportsPage_currentTab', 'requisitionReports') }}">
{% endblock %}

{% block content %}
<div class="main-container">
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-links">
                <a href="{{ url_for('adminHomepage') }}" class="nav-link {% if request.endpoint == 'adminHomepage' %}active{% endif %}">Home</a>
                <a href="{{ url_for('adminSubjectsPage') }}" class="nav-link {% if request.endpoint == 'adminSubjectsPage' %}active{% endif %}">Subjects</a>
                <a href="{{ url_for('adminUsersPage') }}" class="nav-link {% if request.endpoint == 'adminUsersPage' %}active{% endif %}">Users</a>
                <a href="{{ url_for('adminApprovalsPage') }}" class="nav-link {% if request.endpoint == 'adminApprovalsPage' %}active{% endif %}">Approvals</a>
                <a href="{{ url_for('adminReportPage') }}" class="nav-link {% if request.endpoint == 'adminReportPage' %}active{% endif %}">Report</a>
                <a href="{{ url_for('adminProfilePage') }}" class="nav-link {% if request.endpoint == 'adminProfilePage' %}active{% endif %}">Profile</a>
            </div>
        </div>
    </nav>    

    <div class="content-wrapper">
        <h2 class="page-title">Report Generator</h2>
        <p class="page-description">Fill out the form below to generate a requisition or claim report.</p>
        
        <div class="lecturer-info">
            <h3>Report Details</h3>
            <div class="lecturer-row">
                <div class="lecturer-group">
                    <label for="reportType">Report Type:</label>
                    <select id="reportType" name="report_type" required>
                        <option value="">Select Report Type</option>
                        <option value="requisition">Requisition</option>
                        <option value="claim">Claim</option>
                    </select>
                </div>
               <div class="lecturer-group">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" name="start_date" required />
                </div>
                <div class="lecturer-group">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" name="end_date" required />
                </div>
            </div>
        </div>
        <div class="form-buttons">
            <button type="button" id="generateBtn" class="form-btn">Generate</button>
        </div>
    </div>

    <h2>Table Records</h2>

    <!-- Create tabs and content container -->
    <div class="tabs-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openAdminReportsTab(event, 'requisitionReports')">Requisitions</button>
            <button class="tab-button" onclick="openAdminReportsTab(event, 'claimReports')">Claims</button>
        </div>

        <!-- Content for each tab -->
        <div id="requisitionReports" class="tab-content" style="display:none;">
            <div>
                <div class="search-container">
                    <input type="text" class="table-search" placeholder="Search..." data-table="requisitionReportsTable">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="table-responsive">
                <table id="requisitionReportsTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>File</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for requisitionReport in requisitionReports %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <a href="{{ requisitionReport.file_url }}" target="_blank" style="color: #007bff; text-decoration: underline;">
                                    {{ requisitionReport.file_name }}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="claimReports" class="tab-content" style="display:none;">
            <div>
                <div class="search-container">
                    <input type="text" class="table-search" placeholder="Search..." data-table="claimReportsTable">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="table-responsive">
                <table id="claimReportsTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>File</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for claimReport in claimReports %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <a href="{{ claimReport.file_url }}" target="_blank" style="color: #007bff; text-decoration: underline;">
                                    {{ claimReport.file_name }}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div> 
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");

        // Set minimum start date to today
        const todayStr = todayLocalISO();

        // When start date changes, restrict end date
        startDate.addEventListener("change", () => {
            endDate.value = ""; // reset end date
            endDate.setAttribute("min", startDate.value);
        });

        generateBtn.addEventListener('click', async function(e) {
            e.preventDefault();

            if (!validateReportDetails()) return;

            // Show loading overlay
            document.getElementById("loadingOverlay").style.display = "flex";

            const formData = new FormData();
            formData.append('report_type', document.getElementById('reportType').value);
            formData.append('start_date', document.getElementById('startDate').value);
            formData.append('end_date', document.getElementById('endDate').value);

            // Send form data to server
            fetch('/reportConversionResult', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("loadingOverlay").style.display = "none";
                if (data.success) {
                    const reportType = document.getElementById('reportType').value;

                    Swal.fire({
                        icon: 'success',
                        title: 'Report Generated!',
                        text: 'Your report has been successfully processed.',
                        confirmButtonColor: '#3085d6',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        // Redirect after alert closes
                        window.location.href = `/reportConversionResultPage?type=${reportType}`;
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Unknown error occurred while processing the report.',
                        confirmButtonColor: '#d33'
                    });
                }
            })
            .catch(error => {
                document.getElementById("loadingOverlay").style.display = "none";
                Swal.fire({
                    icon: 'warning',
                    title: 'Submission Failed',
                    text: 'Error submitting form: ' + error.message,
                    confirmButtonColor: '#f39c12'
                });
            });
        });  

        const pageKey = 'lastActiveTab_' + window.location.pathname;
        let lastTab = localStorage.getItem(pageKey);

        if (!lastTab) {
            lastTab = document.querySelector('meta[name="current-tab"]')?.content;
        }

        const tabButton = document.querySelector(`.tab-button[onclick*="${lastTab}"]`);
        if (tabButton) {
            tabButton.click();
        }
        
        setupTableSearch();
    });
</script>
{% endblock %}
