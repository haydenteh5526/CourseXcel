{% extends "base.html" %}

{% block title %}Program Officer Dashboard - CourseXcel{% endblock %}

{% block content %}
<div class="main-container">
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-links">
                <a href="{{ url_for('poHomepage') }}" class="nav-link {% if request.endpoint == 'poHomepage' %}active{% endif %}">Home</a>
                <a href="{{ url_for('poFormPage') }}" class="nav-link {% if request.endpoint == 'poFormPage' %}active{% endif %}">Form</a>
                <a href="{{ url_for('poRecordsPage') }}" class="nav-link {% if request.endpoint == 'poRecordsPage' %}active{% endif %}">Records</a>
                <a href="{{ url_for('poApprovalsPage') }}" class="nav-link {% if request.endpoint == 'poApprovalsPage' %}active{% endif %}">Approvals</a>
                <a href="{{ url_for('poProfilePage') }}" class="nav-link {% if request.endpoint == 'poProfilePage' %}active{% endif %}">Profile</a>
            </div>
        </div>
    </nav>  

    <div class="content-wrapper">
        {% if not two_factor_enabled %}
        <div class="alert alert-warning" style="text-align:center; padding:15px 10px;">
            <i class="fa-solid fa-shield-halved" style="margin-right:6px;"></i>
            <b>Secure your account:</b>
            <span style="margin-left:4px;">You havenâ€™t enabled Two-Factor Authentication yet.</span>
            <a href="{{ url_for('twofa_setup', role='program_officer', user_id=po_id) }}" class="ttwofa-button-home">
                Set Up 2FA
            </a>
        </div><hr style="margin: 20px 0;">
        {% endif %}

        <!-- Action Cards Row -->
        <div class="action-cards">
            <!-- Generate Requisition -->
            <div class="card action-card lecturer-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Generate Requisition</h3>
                <p class="form-text">Fill out the form to generate part-time requisitions.</p>
                <a href="{{ url_for('poFormPage') }}" class="form-btn">Go</a>
            </div>

            <!-- Manage Records -->
            <div class="card action-card course-card">
                <h3><i class="fas fa-upload"></i> Manage Records</h3>
                <p class="form-text">Manage subjects and part-time lecturers.</p>
                <a href="{{ url_for('poRecordsPage') }}" class="form-btn">Go</a>
            </div>

            <!-- View Approvals -->
            <div class="card action-card head-card">
                <h3><i class="fas fa-user-tie"></i> View Approvals</h3>
                <p class="form-text">View requisition and claim approval statuses.</p>
                <a href="{{ url_for('poApprovalsPage') }}" class="form-btn">Go</a>
            </div>
        </div>

        <!-- Dashboard Charts -->
        <div class="dashboard-grid">
            <!-- Subjects per Lecturer -->
            <div class="card">
                <h3>Subjects Assigned per Part-Time Lecturer</h3>
                <canvas id="subjectsPerLecturerChart"></canvas>
            </div>

            <!-- Hours taught vs. Assigned -->
            <div class="card">
                <div class="card-header">
                    <h3>Hours Taught vs Assigned</h3>
                    <select id="lecturer">
                        {% for lect in lecturers %}
                            <option value="{{ lect.name }}">{{ lect.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <canvas id="lecturerHoursChart"></canvas>
            </div>

            <!-- Lecturer Claim Trend -->
            <div class="card">
                <div class="card-header">
                    <h3>Part-Time Lecturer Claim Trend</h3>
                    <select id="claimTrendLecturer">
                        {% for lect in lecturers %}
                            <option value="{{ lect.name }}">{{ lect.name }}</option>
                        {% endfor %}
                    </select>
                    <select id="claimTrendYear"></select>
                </div>
                <canvas id="claimTrendChart"></canvas>
            </div>

            <!-- Pie Chart for Records -->
            <div class="card">
                <h3>Records Distribution</h3>
                <canvas id="recordsPieChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/po.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Define a palette of 10 colors
        const lecturerPalette = [
            "#e84393", // Pink
            "#e74c3c", // Red
            "#e67e22", // Orange
            "#f1c40f", // Yellow
            "#2ecc71", // Green
            "#3498db", // Blue
            "#8e44ad", // Indigo
            "#7f8c8d"  // Gray
        ];

        // Generate lighter/darker shades
        function shadeColor(color, percent, alpha = 0.7) {
            let R = parseInt(color.substring(1,3),16);
            let G = parseInt(color.substring(3,5),16);
            let B = parseInt(color.substring(5,7),16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;

            return `rgba(${R}, ${G}, ${B}, ${alpha})`;
        }

        // ========== Subjects per Lecturer ==========
        const lecturerSubjects = JSON.parse('{{ lecturer_subjects | tojson | safe }}');

        // Extract labels and counts separately
        const labels = lecturerSubjects.map(item => item.lecturer);
        const counts = lecturerSubjects.map(item => item.count);

        // Assign colors with shade variations
        const colors = labels.map((_, i) => {
            const baseColor = lecturerPalette[i % lecturerPalette.length];
            const shade = (Math.floor(i / lecturerPalette.length) - 1) * 20; 
            return shadeColor(baseColor, shade);
        });

        new Chart(document.getElementById('subjectsPerLecturerChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: "Subjects",
                    data: counts,
                    backgroundColor: colors
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1, 
                            callback: function(value) {
                                return Number.isInteger(value) ? value : null; 
                            }
                        },
                        title: {
                            display: true,
                            text: 'Number of Subjects',
                        }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        // ========== Hours taught vs assigned ==========
        const lecturerHours = JSON.parse('{{ lecturer_hours | tojson | safe }}');

        function renderHoursChart(lecturerName) {
            const ctx = document.getElementById("lecturerHoursChart").getContext("2d");
            const data = lecturerHours[lecturerName] || [];

            const labels = data.map(item => item.subject);
            const assigned = data.map(item => item.assigned);
            const taught = data.map(item => item.taught);

            if (window.hoursChart) {
                window.hoursChart.destroy();
            } 

            window.hoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Assigned Hours",
                            data: assigned,
                            backgroundColor: "rgba(230, 126, 34, 0.6)",
                            pointStyle: 'rect'
                        },
                        {
                            label: "Taught Hours",
                            data: taught,
                            type: 'line',
                            borderColor: "rgba(232, 67, 147, 1)",   // solid line
                            borderWidth: 3,
                            fill: false,   // enable shaded area
                            tension: 0.3,
                            pointStyle: 'circle'
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10, 
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : null; 
                                }
                            },
                            title: { display: true, text: "Hours" }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { usePointStyle: true }
                        }
                    }
                }
            });
        }

        // Init
        const defaultLecturer = document.getElementById("lecturer").value;
        renderHoursChart(defaultLecturer);

        // Change event
        document.getElementById("lecturer").addEventListener("change", function () {
            renderHoursChart(this.value);
        });

        // ========== Claim Trend ==========
        const lecturerClaims = JSON.parse('{{ lecturer_claims | tojson | safe }}');
        const monthLabels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

        function populateYears(lecturerId) {
            const yearSelect = document.getElementById("claimTrendYear");
            yearSelect.innerHTML = ""; // reset

            const years = Object.keys(lecturerClaims[lecturerId] || {}).sort();
            years.forEach(y => {
                const opt = document.createElement("option");
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });
        }

        function renderClaimChart(lecturerId, year) {
            const ctx = document.getElementById('claimTrendChart').getContext('2d');
            const data = (lecturerClaims[lecturerId] && lecturerClaims[lecturerId][year]) || [];

            // Convert to array aligned by months
            const values = monthLabels.map((_, i) => {
                const monthData = data.find(item => item.month === i+1);
                return monthData ? monthData.total_claims / 1000 : 0; // RM'000
            });

            if (window.claimChart) {
                window.claimChart.destroy();
            }

            window.claimChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: "Claims",
                        data: values,
                        borderColor: "#3498db",
                        backgroundColor: "rgba(52,152,219,0.3)", 
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 0.5 },
                            title: { display: true, text: "Total Claims" }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const month = context.label; // "Jan", "Feb", etc.
                                    const value = context.raw;   // numeric value
                                    return `Claims: RM ${value}k`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Init: default lecturer and its first year
        const defaultClaimLecturer = document.getElementById("claimTrendLecturer").value;
        populateYears(defaultClaimLecturer);
        const defaultClaimYear = document.getElementById("claimTrendYear").value;
        renderClaimChart(defaultClaimLecturer, defaultClaimYear);

        // Change events
        document.getElementById("claimTrendLecturer").addEventListener("change", function() {
            populateYears(this.value);
            const firstYear = document.getElementById("claimTrendYear").value;
            renderClaimChart(this.value, firstYear);
        });

        document.getElementById("claimTrendYear").addEventListener("change", function() {
            const lecturerName = document.getElementById("claimTrendLecturer").value;
            renderClaimChart(lecturerName, this.value);
        });

        // ========== Records Pie Chart ==========
        const recordsData = JSON.parse('{{ records_counts | tojson | safe }}');

        new Chart(document.getElementById('recordsPieChart'), {
            type: 'pie',
            data: {
                labels: ["Subjects", "Part-Time Lecturers", "Requisition Approvals", "Claim Approvals"],
                datasets: [{
                    data: recordsData,
                    backgroundColor: [
                        shadeColor("#e74c3c", 0, 0.7),  /* red */
                        shadeColor("#e67e22", 0, 0.7),  /* orange */
                        shadeColor("#2ecc71", 0, 0.7),  /* green */
                        shadeColor("#3498db", 0, 0.7),  /* blue */
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.8, // lower = taller, higher = wider
                plugins: { legend: { position: 'top' } }
            }
        });
    });

</script>

{% endblock %}
