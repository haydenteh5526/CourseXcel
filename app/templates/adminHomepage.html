{% extends "base.html" %}

{% block title %}Admin Dashboard - CourseXcel{% endblock %}

{% block content %}
<div class="main-container">
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-links">
                <a href="{{ url_for('adminHomepage') }}" class="nav-link {% if request.endpoint == 'adminHomepage' %}active{% endif %}">Home</a>
                <a href="{{ url_for('adminSubjectsPage') }}" class="nav-link {% if request.endpoint == 'adminSubjectsPage' %}active{% endif %}">Subjects</a>
                <a href="{{ url_for('adminUsersPage') }}" class="nav-link {% if request.endpoint == 'adminUsersPage' %}active{% endif %}">Users</a>
                <a href="{{ url_for('adminApprovalsPage') }}" class="nav-link {% if request.endpoint == 'adminApprovalsPage' %}active{% endif %}">Approvals</a>
                <a href="{{ url_for('adminReportPage') }}" class="nav-link {% if request.endpoint == 'adminReportPage' %}active{% endif %}">Report</a>
                <a href="{{ url_for('adminProfilePage') }}" class="nav-link {% if request.endpoint == 'adminProfilePage' %}active{% endif %}">Profile</a>
            </div>
        </div>
    </nav>    

    <div class="content-wrapper">
        <button type="button" id="downloadBtn" class="form-btn">Download Approval Files</button>   
        <br>
        <small class="form-text text-muted">
            This button will download all requisition and claim approval files, along with their attachments, that have completed the approval process.<br>After the download is prepared, the files will be cleared from the database and storage.
            <br><br>
            <details class="mt-1">
                <summary><strong>Conditions to download</strong></summary>
                <ul class="mb-1">
                    <li>The requisition and claim approval status must be marked as <em>Completed</em>.</li>
                    <li>The teaching period end date (the latest end date across all subjects in the requisition) must be at least four months before todayâ€™s date.</li>
                    <li>The total cost from all lecturer subjects must equal the total cost already claimed, meaning there is nothing left to claim.</li>
                </ul>
            </details>
            <strong>In summary:</strong> Only fully completed requisitions and claims that are past their teaching period and have no remaining unclaimed costs meet the conditions.
        </small>

        <br><br>

        <h3>Google Drive Files (Uploaded by Service Account)</h3>
        <form method="POST" action="/adminHomepage">
            <ul>
                {% for file in files %}
                    <li>
                        <input type="checkbox" name="file_ids" value="{{ file.id }}"> 
                        <a href="{{ file.webViewLink }}" target="_blank">{{ file.name }}</a>
                    </li>
                {% else %}
                    <li>No files found.</li>
                {% endfor %}
            </ul>
            <button type="submit" class="btn btn-danger">Delete Selected Files</button>
        </form>

        <h3>Google Drive Storage</h3>
        <p>Used: {{ used_gb }} GB / {{ total_gb }} GB</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        downloadBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!confirm('Are you sure you want to proceed?')) return;

            try {
                document.getElementById("loadingOverlay").style.display = "flex";
                const response = await fetch('/api/download_files_zip', { method: 'POST' });
                document.getElementById("loadingOverlay").style.display = "none";

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    alert(data.error || 'Failed to prepare download.');
                    return;
                }

                // Download the ZIP
                const disposition = response.headers.get('Content-Disposition') || '';
                const match = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"/i.exec(disposition);
                const filename = decodeURIComponent(match?.[1] || match?.[2] || `Approvals and Attachments_${new Date().toISOString().slice(0,10)}.zip`);

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                a.download = filename;
                document.body.appendChild(a); 
                a.click();
                URL.revokeObjectURL(url); 
                a.remove();

                // Cleanup on the server
                const cleanup = await fetch('/api/cleanup_downloaded_files', { method: 'POST' });
                const result = await cleanup.json().catch(() => ({}));
                if (!cleanup.ok) {
                    alert(result.error || 'Cleanup failed on the server.');
                } else {
                    alert('Download prepared and records cleaned up successfully.');
                }
            } catch (err) {
                document.getElementById("loadingOverlay").style.display = "none";
                alert('Error preparing download: ' + err.message);
            }
        });
    });
</script>
{% endblock %}
